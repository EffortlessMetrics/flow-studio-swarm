# Flow Studio Wisdom UI Design

> **Status**: Design Draft (v2.4.0 Target)
> **Created**: December 2025

---

## Problem Statement

Wisdom summary data (`wisdom_summary.json`) is generated by Flow 6 but not visible in the Flow Studio UI. Users must access files directly via the filesystem or use CLI tools like `wisdom_aggregate_runs.py` to view wisdom metrics.

This creates friction for:
- **Operators** who want to quickly assess run health
- **Authors** who need to compare wisdom metrics across runs
- **New users** learning the SDLC through example runs

---

## Goals

1. Display wisdom summary for selected run in Flow Studio
2. Surface key metrics: artifacts present, regressions, learnings
3. Enable cross-run comparison of wisdom metrics
4. Integrate with existing inspector panel UX patterns

## Non-Goals

- Real-time wisdom generation (wisdom is generated offline by Flow 6)
- Wisdom editing from UI (wisdom is read-only in Flow Studio)
- Advanced analytics dashboards (keep it simple and focused)
- Wisdom aggregation UI (use CLI for cross-run aggregation)

---

## Data Source

Wisdom summaries are stored at:
```
RUN_BASE/wisdom/wisdom_summary.json
```

Example paths:
- `swarm/examples/health-check/wisdom/wisdom_summary.json`
- `swarm/runs/<run-id>/wisdom/wisdom_summary.json`

### Current Schema (from wisdom_summarizer.py)

```json
{
  "run_id": "health-check",
  "created_at": "2025-12-10T00:50:15.167347+00:00",
  "flows": {
    "signal": { "status": "succeeded" },
    "plan": { "status": "succeeded" },
    "build": { "status": "succeeded" },
    "gate": { "status": "succeeded" },
    "deploy": { "status": "skipped" },
    "wisdom": { "status": "skipped" }
  },
  "summary": {
    "artifacts_present": 0,
    "regressions_found": 0,
    "learnings_count": 0,
    "feedback_actions_count": 0,
    "issues_created": 0
  },
  "labels": [],
  "key_artifacts": {}
}
```

---

## API Extensions

### New Endpoint: GET /api/runs/{run_id}/wisdom/summary

Returns the wisdom summary for a specific run.

**Response Schema:**

```typescript
interface WisdomSummaryResponse {
  /** The run identifier */
  run_id: string;

  /** ISO timestamp when wisdom was generated */
  created_at: string;

  /** Per-flow status from wisdom analysis */
  flows: Record<FlowKey, FlowWisdomStatus>;

  /** Aggregated metrics from wisdom analysis */
  summary: WisdomMetrics;

  /** Labels applied during wisdom analysis */
  labels: string[];

  /** Key artifacts with paths */
  key_artifacts: Record<string, string>;
}

interface FlowWisdomStatus {
  /** Flow execution status */
  status: "succeeded" | "failed" | "skipped" | "partial";

  /** Number of microloop iterations (if applicable) */
  microloops?: number;
}

interface WisdomMetrics {
  /** Number of expected artifacts that are present */
  artifacts_present: number;

  /** Number of regressions detected */
  regressions_found: number;

  /** Number of learnings extracted */
  learnings_count: number;

  /** Number of feedback actions recommended */
  feedback_actions_count: number;

  /** Number of GitHub issues created */
  issues_created: number;
}
```

**Error Responses:**
- `404`: Run not found or no wisdom summary available
- `500`: Server error reading wisdom data

### New Endpoint: GET /api/runs/{run_id}/health

Returns a computed health score for the run based on wisdom and artifact data.

**Response Schema:**

```typescript
interface RunHealthResponse {
  /** The run identifier */
  run_id: string;

  /** Overall health score (0-100) */
  health_score: number;

  /** Health status derived from score */
  health_status: "healthy" | "warning" | "critical" | "unknown";

  /** Breakdown of score components */
  breakdown: HealthBreakdown;
}

interface HealthBreakdown {
  /** Score component from artifact presence (0-30) */
  artifacts_score: number;

  /** Score component from flow success rate (0-40) */
  flows_score: number;

  /** Score component from regression count (0-30, inverse) */
  regressions_score: number;

  /** Details for each component */
  details: {
    artifacts: { present: number; expected: number };
    flows: { succeeded: number; total: number };
    regressions: { count: number };
  };
}
```

---

## TypeScript Changes

### domain.ts Additions

Add the following interfaces to `swarm/tools/flow_studio_ui/src/domain.ts`:

```typescript
// ============================================================================
// Wisdom API
// ============================================================================

/** Flow status from wisdom analysis */
export interface FlowWisdomStatus {
  /** Flow execution status */
  status: "succeeded" | "failed" | "skipped" | "partial";
  /** Number of microloop iterations (if applicable) */
  microloops?: number;
}

/** Aggregated metrics from wisdom analysis */
export interface WisdomMetrics {
  /** Number of expected artifacts that are present */
  artifacts_present: number;
  /** Number of regressions detected */
  regressions_found: number;
  /** Number of learnings extracted */
  learnings_count: number;
  /** Number of feedback actions recommended */
  feedback_actions_count: number;
  /** Number of GitHub issues created */
  issues_created: number;
}

/** Full wisdom summary for a run */
export interface WisdomSummary {
  /** The run identifier */
  run_id: string;
  /** ISO timestamp when wisdom was generated */
  created_at: string;
  /** Per-flow status from wisdom analysis */
  flows: Record<FlowKey, FlowWisdomStatus>;
  /** Aggregated metrics from wisdom analysis */
  summary: WisdomMetrics;
  /** Labels applied during wisdom analysis */
  labels: string[];
  /** Key artifacts with paths */
  key_artifacts: Record<string, string>;
}

/** Response from /api/runs/{run_id}/wisdom/summary */
export interface WisdomSummaryResponse extends WisdomSummary {}

/** Health score breakdown */
export interface HealthBreakdown {
  /** Score component from artifact presence (0-30) */
  artifacts_score: number;
  /** Score component from flow success rate (0-40) */
  flows_score: number;
  /** Score component from regression count (0-30, inverse) */
  regressions_score: number;
  /** Details for each component */
  details: {
    artifacts: { present: number; expected: number };
    flows: { succeeded: number; total: number };
    regressions: { count: number };
  };
}

/** Response from /api/runs/{run_id}/health */
export interface RunHealthResponse {
  /** The run identifier */
  run_id: string;
  /** Overall health score (0-100) */
  health_score: number;
  /** Health status derived from score */
  health_status: "healthy" | "warning" | "critical" | "unknown";
  /** Breakdown of score components */
  breakdown: HealthBreakdown;
}
```

### api.ts Additions

Add the following methods to the `Api` object in `swarm/tools/flow_studio_ui/src/api.ts`:

```typescript
// ============================================================================
// Wisdom
// ============================================================================

/**
 * Get wisdom summary for a run.
 * Returns null-safe wrapper for runs without wisdom data.
 */
getWisdomSummary(runId: string): Promise<WisdomSummaryResponse> {
  return fetchJSON<WisdomSummaryResponse>(
    `/api/runs/${encodeURIComponent(runId)}/wisdom/summary`
  );
},

/**
 * Get health score for a run.
 * Computed from wisdom and artifact data.
 */
getRunHealth(runId: string): Promise<RunHealthResponse> {
  return fetchJSON<RunHealthResponse>(
    `/api/runs/${encodeURIComponent(runId)}/health`
  );
},
```

---

## UI Components

### Inspector: Wisdom Tab

Add a new tab to the inspector panel when viewing a run. The tab displays:

**Summary Card:**
```
+------------------------------------------+
| Wisdom Summary                           |
+------------------------------------------+
| Created: 2025-12-10 00:50:15            |
|                                          |
| Metrics                                  |
| +--------------------------------------+ |
| | Artifacts Present  |  12 / 15        | |
| | Regressions Found  |   0             | |
| | Learnings          |   3             | |
| | Feedback Actions   |   2             | |
| | Issues Created     |   1             | |
| +--------------------------------------+ |
|                                          |
| Labels: [regression-free] [full-cycle]   |
+------------------------------------------+
```

**Flow Status Breakdown (7 flows):**
```
+------------------------------------------+
| Flow Status                              |
+------------------------------------------+
| signal  | [green dot] succeeded         |
| plan    | [green dot] succeeded         |
| build   | [green dot] succeeded         |
| gate    | [green dot] succeeded         |
| deploy  | [gray dot]  skipped           |
| wisdom  | [gray dot]  skipped           |
+------------------------------------------+
```

**Key Artifacts (expandable):**
```
+------------------------------------------+
| Key Artifacts                       [v]  |
+------------------------------------------+
| problem_statement.md                     |
| adr.md                                   |
| build_receipt.json                       |
+------------------------------------------+
```

### SDLC Bar Enhancement

Extend the SDLC progress bar to show wisdom status:

- **Green dot**: Wisdom exists and no regressions found
- **Yellow dot**: Wisdom exists with warnings (e.g., missing artifacts)
- **Red dot**: Wisdom exists with regressions found
- **Gray dot**: No wisdom data for this run

The dot appears after the "wisdom" flow segment in the SDLC bar.

### UIID Additions

Add the following UIIDs to the `FlowStudioUIID` type in domain.ts:

```typescript
// Wisdom Tab (Inspector)
| "flow_studio.inspector.wisdom"
| "flow_studio.inspector.wisdom.summary"
| "flow_studio.inspector.wisdom.metrics"
| "flow_studio.inspector.wisdom.flows"
| "flow_studio.inspector.wisdom.labels"
| "flow_studio.inspector.wisdom.artifacts"

// SDLC Bar (Wisdom indicator)
| "flow_studio.sdlc_bar.wisdom_status"
```

---

## Implementation Phases

### Phase A: API Endpoints (Python)

1. Add `get_wisdom_summary()` endpoint to `flow_studio_fastapi.py`
2. Add `get_run_health()` endpoint to `flow_studio_fastapi.py`
3. Implement file reading from `RUN_BASE/wisdom/wisdom_summary.json`
4. Add error handling for missing wisdom data (return 404)
5. Add tests in `tests/test_flow_studio_wisdom_api.py`

**Estimated effort**: 1-2 hours

### Phase B: TypeScript Types

1. Add `WisdomSummary`, `FlowWisdomStatus`, `WisdomMetrics` to domain.ts
2. Add `RunHealthResponse`, `HealthBreakdown` to domain.ts
3. Add `getWisdomSummary()`, `getRunHealth()` to api.ts
4. Run `make ts-check` to verify types

**Estimated effort**: 30 minutes

### Phase C: Inspector Tab

1. Create `wisdom_tab.ts` module in `src/modules/`
2. Add "Wisdom" tab to inspector panel (alongside existing tabs)
3. Implement summary card with metrics display
4. Implement flow status breakdown with colored dots
5. Implement labels as badges
6. Implement collapsible key artifacts section
7. Add data-uiid attributes for testing

**Estimated effort**: 2-3 hours

### Phase D: SDLC Bar Indicator

1. Extend SDLC bar rendering to include wisdom indicator
2. Add colored dot after wisdom flow segment
3. Add tooltip showing wisdom status on hover
4. Add data-uiid for wisdom status indicator

**Estimated effort**: 1 hour

### Phase E: Tests

1. Unit tests for API endpoints (Python)
2. TypeScript type tests (compile-time)
3. Integration tests for inspector tab rendering
4. E2E test for wisdom tab visibility

**Estimated effort**: 1-2 hours

---

## Open Questions

### Q1: Should wisdom tab be visible for runs without wisdom data?

**Options:**
- A) Hide the tab entirely (cleaner UI)
- B) Show tab with "No wisdom data" message (consistent navigation)
- C) Show tab grayed out (indicates feature exists)

**Recommendation**: Option B - Show tab with empty state message. This is consistent with how other tabs handle missing data and helps users discover the feature.

### Q2: Should health score affect run sorting in selector?

**Options:**
- A) No sorting by health (maintain current behavior)
- B) Sort unhealthy runs to top (draw attention to issues)
- C) Add optional health filter (let user choose)

**Recommendation**: Option C - Add filter. Don't change default sort, but allow filtering to "runs with regressions" or "healthy runs only".

### Q3: How to handle partial wisdom (only some flows)?

**Options:**
- A) Show whatever data exists
- B) Mark as "incomplete" with visual indicator
- C) Calculate health score only from available data

**Recommendation**: All three - Show available data, mark as incomplete, and note partial health score in breakdown.

### Q4: Should we cache wisdom data?

The current design fetches wisdom on-demand when the tab is opened. For v2.4.0, this is sufficient. Consider caching if:
- Users frequently switch between runs
- Wisdom summaries are large (unlikely)
- API latency becomes noticeable

---

## Compatibility

### Backward Compatibility

- Runs without wisdom data continue to work (404 handled gracefully)
- Existing API endpoints unchanged
- No breaking changes to existing UI components

### Forward Compatibility

- Schema designed to accommodate future wisdom fields
- Labels array allows extensible categorization
- Key artifacts map supports arbitrary artifact types

---

## See Also

- [RELEASE_NOTES_2_3_0.md](./RELEASE_NOTES_2_3_0.md) - v2.3.0 release notes (wisdom cycle tooling)
- [flow_studio_fastapi.py](../swarm/tools/flow_studio_fastapi.py) - FastAPI implementation
- [domain.ts](../swarm/tools/flow_studio_ui/src/domain.ts) - TypeScript domain types
- [api.ts](../swarm/tools/flow_studio_ui/src/api.ts) - API client methods
- [wisdom_summarizer.py](../swarm/tools/wisdom_summarizer.py) - Wisdom summary generator
- [wisdom_aggregate_runs.py](../swarm/tools/wisdom_aggregate_runs.py) - Cross-run aggregation
