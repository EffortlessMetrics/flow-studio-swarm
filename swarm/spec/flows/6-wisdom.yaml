# Flow: 6-wisdom
# Purpose: Prod -> Wisdom: Analyze artifacts, extract learnings, close feedback loops

id: 6-wisdom
version: 1
title: "Flow 6 - Wisdom"
description: |
  Retrospective factory: analyze all flow artifacts, detect regressions,
  compile history, synthesize learnings, and apply feedback to future runs.
  Writes scent trail to `.runs/_wisdom/latest.md` for future run context.

defaults:
  context_pack:
    include_upstream_artifacts: true
    include_previous_envelopes: true
    max_envelopes: 10
    include_scent_trail: true
  sdk_overrides: {}

steps:
  # Step 1: Audit all flow artifacts
  - id: audit_artifacts
    station: artifact-auditor
    objective: |
      Verify all expected flow artifacts exist from prior flows.
      Check structural sanity of receipts, contracts, and outputs.
      Document missing or malformed artifacts.
    inputs:
      - signal/signal_receipt.json
      - plan/plan_receipt.json
      - build/build_receipt.json
      - gate/gate_receipt.json
      - deploy/deploy_receipt.json
    outputs:
      - wisdom/artifact_audit.md
    routing:
      kind: linear
      next: analyze_regressions
    teaching:
      highlight: true
      note: "Artifact audit: verify all upstream flows produced expected outputs"

  # Step 2: Analyze regressions
  - id: analyze_regressions
    station: regression-analyst
    objective: |
      Check for test regressions, coverage changes, and stability issues.
      Compare current state to prior runs if available.
      Document any regressions with evidence.
    inputs:
      - wisdom/artifact_audit.md
      - build/build_receipt.json
      - gate/gate_receipt.json
    outputs:
      - wisdom/regression_report.md
    routing:
      kind: linear
      next: compile_history
    teaching:
      highlight: true
      note: "Regression analysis: what got worse and why"

  # Step 3: Compile flow history
  - id: compile_history
    station: flow-historian
    objective: |
      Build timeline linking all flow events.
      Calculate Developer Lead Time (DevLT): human attention required.
      Document flow durations, stalls, and iteration counts.
    inputs:
      - wisdom/artifact_audit.md
      - wisdom/regression_report.md
      - signal/signal_receipt.json
      - plan/plan_receipt.json
      - build/build_receipt.json
      - gate/gate_receipt.json
      - deploy/deploy_receipt.json
    outputs:
      - wisdom/flow_history.json
    routing:
      kind: linear
      next: synthesize_learnings
    teaching:
      note: "Timeline compilation: how long did this take, where did we stall"

  # Step 4: Synthesize learnings
  - id: synthesize_learnings
    station: learning-synthesizer
    objective: |
      Extract patterns from the analysis: what worked, what failed.
      Identify problem patterns for future requirement templates.
      Produce narrative lessons learned.
    inputs:
      - wisdom/artifact_audit.md
      - wisdom/regression_report.md
      - wisdom/flow_history.json
    outputs:
      - wisdom/learnings.md
    routing:
      kind: linear
      next: apply_feedback
    teaching:
      highlight: true
      note: "Synthesize: extract actionable patterns and lessons"

  # Step 5: Apply feedback
  - id: apply_feedback
    station: feedback-applier
    objective: |
      Turn learnings into concrete actions: issue drafts, doc updates.
      Write pack improvements as suggested diffs.
      Write scent trail to `.runs/_wisdom/latest.md` for future runs.
    inputs:
      - wisdom/learnings.md
      - wisdom/flow_history.json
      - wisdom/regression_report.md
    outputs:
      - wisdom/feedback_actions.md
      - wisdom/pack_improvements.md
      - wisdom/codebase_wisdom.md
      - _wisdom/latest.md
    routing:
      kind: terminal
    teaching:
      highlight: true
      note: "Feedback loop closure: scent trail informs future runs"

cross_cutting_stations:
  - clarifier
  - risk-analyst
