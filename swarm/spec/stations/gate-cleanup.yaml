# Station: gate-cleanup
# Source: swarm/prompts/agentic_steps/gate-cleanup.md
# Role: Seal the envelope at end of Flow 5 (Gate) - verify artifacts, write receipt, update index

id: gate-cleanup
version: 2
title: Gate Cleanup
category: infra

sdk:
  model: haiku
  permission_mode: bypassPermissions
  allowed_tools:
    - Read
    - Write
    - Edit
    - Bash
    - Grep
    - Glob
  sandbox:
    enabled: true
    auto_allow_bash: true
  max_turns: 10
  context_budget:
    total_chars: 100000
    recent_chars: 40000
    older_chars: 6000

identity:
  system_append: |
    You are the Gate Cleanup Agent. You seal the envelope at the end of Flow 5.

    You produce the structured summary (receipt) of the gate outcome. The receipt
    captures what happened - it is a log, not a gatekeeper. The merge decision is
    based on current evidence; the receipt is the audit trail.

    Receipt Supremacy: gate_receipt.json supersedes build_receipt.json as the
    authoritative evidence. When fix-forward runs in Gate, the SHA has moved.
    Do not require build_receipt.json regeneration - that's bureaucratic paperwork.

    You own:
    - .runs/<run-id>/gate/gate_receipt.json
    - .runs/<run-id>/gate/cleanup_report.md
    - Updating .runs/index.json fields you own: status, last_flow, updated_at

    Anchor parsing to Machine Summary blocks. Use demoswarm shim for mechanical ops.
  longform_ref: prompts/agentic_steps/gate-cleanup.md
  tone: neutral

policy:
  invariants_ref:
    - fragments/common/invariants.md
  handoff_ref:
    - fragments/common/handoff.md

io:
  required_inputs:
    - gate/merge_decision.md
  optional_inputs:
    - gate/receipt_audit.md
    - gate/contract_compliance.md
    - gate/security_scan.md
    - gate/coverage_audit.md
    - gate/policy_analysis.md
    - gate/risk_assessment.md
    - gate/gate_fix_summary.md
    - gate/flow_plan.md
    - build/build_receipt.json
  required_outputs:
    - gate/gate_receipt.json
    - gate/cleanup_report.md
  optional_outputs:
    - gate/github_report.md

handoff:
  draft_path_template: "{{run.base}}/handoff/gate-cleanup.draft.json"
  schema_ref: schemas/handoff.schema.json
  required_fields:
    - status
    - summary
    - artifacts
    - routing_signal

verify:
  required_artifacts:
    - gate/gate_receipt.json
    - gate/cleanup_report.md
  gate_status_on_fail: UNVERIFIED

runtime_prompt:
  fragments:
    - common/invariants.md
    - common/handoff.md
  template: |
    ## Gate Cleanup Approach

    1. Preflight: verify you can read/write required paths
    2. Artifact existence: check for merge_decision.md (required)
    3. Extract verdict + quality gate statuses from Machine Summary blocks
    4. Mechanical counts: receipt checks, contract violations, security findings, coverage
    5. Derive receipt status + recommended_action based on verdict and gates
    6. Write gate_receipt.json with all counts and statuses
    7. Update .runs/index.json (status, last_flow, updated_at only)
    8. Write cleanup_report.md and github_report.md

    ## Status Decision

    - VERIFIED: merge_verdict MERGE AND required artifacts present AND gates VERIFIED
    - UNVERIFIED: BOUNCE verdict OR artifacts missing OR gates incomplete
    - CANNOT_PROCEED: IO/permissions failure

invariants:
  - "Mechanical counts only - Machine Summary fields or stable markers"
  - "Null over guess - explain every null in blockers/concerns"
  - "Use demoswarm shim for all mechanical operations"
  - "No git operations"
  - "Never reinterpret the merge verdict - copy it exactly"
  - "gate_receipt.json supersedes build_receipt.json"

routing_hints:
  on_verified: complete
  on_unverified: advance_with_concerns
  on_partial: advance_with_concerns
  on_blocked: escalate
