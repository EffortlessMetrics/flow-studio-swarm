# Station: signal-cleanup
# Source: swarm/prompts/agentic_steps/signal-cleanup.md
# Role: Seal the envelope at end of Flow 1 - derive counts, write receipt, update index

id: signal-cleanup
version: 2
title: Signal Cleanup
category: infra

sdk:
  model: haiku
  permission_mode: bypassPermissions
  allowed_tools:
    - Read
    - Write
    - Edit
    - Bash
    - Grep
    - Glob
  sandbox:
    enabled: true
    auto_allow_bash: true
  max_turns: 10
  context_budget:
    total_chars: 100000
    recent_chars: 40000
    older_chars: 6000

identity:
  system_append: |
    You are the Signal Cleanup Agent. You seal the envelope at the end of Flow 1.

    You produce the structured summary (receipt) of the signal outcome. The receipt
    captures what happened - it is a log, not a gatekeeper. Downstream agents use
    the receipt as evidence, not permission.

    You own:
    - .runs/<run-id>/signal/signal_receipt.json
    - .runs/<run-id>/signal/cleanup_report.md
    - Updating .runs/index.json fields you own: status, last_flow, updated_at

    Counts are mechanical. If you cannot derive a value safely, output null and explain why.
    Prefer stable markers over heuristics. Avoid smart guesses.
    Use the demoswarm shim for all mechanical operations.
  longform_ref: prompts/agentic_steps/signal-cleanup.md
  tone: neutral

policy:
  invariants_ref:
    - fragments/common/invariants.md
  handoff_ref:
    - fragments/common/handoff.md

io:
  required_inputs:
    - signal/requirements.md
  optional_inputs:
    - signal/requirements_critique.md
    - signal/bdd_critique.md
    - signal/features/*.feature
    - signal/open_questions.md
    - signal/risk_assessment.md
    - signal/early_risks.md
    - signal/verification_notes.md
  required_outputs:
    - signal/signal_receipt.json
    - signal/cleanup_report.md
  optional_outputs:
    - signal/github_report.md

handoff:
  draft_path_template: "{{run.base}}/handoff/signal-cleanup.draft.json"
  schema_ref: schemas/handoff.schema.json
  required_fields:
    - status
    - summary
    - artifacts
    - routing_signal

verify:
  required_artifacts:
    - signal/signal_receipt.json
    - signal/cleanup_report.md
  gate_status_on_fail: UNVERIFIED

runtime_prompt:
  fragments:
    - common/invariants.md
    - common/handoff.md
  template: |
    ## Signal Cleanup Approach

    1. Preflight: verify you can read/write required paths
    2. Artifact existence: check required, recommended, optional artifacts
    3. Mechanical counts: derive REQ/NFR/BDD/risk counts using stable markers
    4. Quality gate status: extract from critic Machine Summary blocks
    5. Derive receipt status + routing based on evidence
    6. Write signal_receipt.json with all counts and statuses
    7. Update .runs/index.json (status, last_flow, updated_at only)
    8. Write cleanup_report.md with artifact verification table
    9. Write github_report.md (pre-composed comment body)

    ## Status Decision

    - VERIFIED: Required artifacts exist, critic gates passed, counts derived
    - UNVERIFIED: Missing required artifacts or critic gates incomplete
    - CANNOT_PROCEED: IO/permissions prevented reading/writing

invariants:
  - "All paths are repo-root-relative"
  - "Write only to .runs/<run-id>/signal/"
  - "Counts are mechanical - null over guess"
  - "Use demoswarm shim for all mechanical operations"
  - "No git operations"
  - "VERIFIED requires executed evidence"

routing_hints:
  on_verified: complete
  on_unverified: advance_with_concerns
  on_partial: advance_with_concerns
  on_blocked: escalate
