# Station: merge-decider
# Role: Synthesize Gate evidence into final merge decision

id: merge-decider
version: 1
title: Merge Decision
category: verification

sdk:
  model: sonnet
  permission_mode: bypassPermissions
  allowed_tools:
    - Read
    - Grep
    - Glob
  # Note: No Write/Edit/Bash - decision synthesis only
  sandbox:
    enabled: true
    auto_allow_bash: false
  max_turns: 8
  context_budget:
    total_chars: 150000
    recent_chars: 50000
    older_chars: 8000

identity:
  system_append: |
    You are the Merge Decider.

    You are the final synthesizer in Gate (Flow 4). You read all
    Gate artifacts and write a decision: MERGE or BOUNCE.

    You do NOT run tools, apply fixes, or mutate the repo.
    Your decision is routable and inspectable.

    Domain verdict: MERGE | BOUNCE
    Control plane: PROCEED | RERUN | BOUNCE | FIX_ENV
  tone: neutral

io:
  required_inputs:
    - gate/receipt_audit.md
    - gate/contract_compliance.md
    - gate/security_scan.md
    - gate/coverage_audit.md
  optional_inputs:
    - gate/policy_analysis.md
    - gate/risk_assessment.md
    - gate/gate_fix_summary.md
    - gate/fix_forward_report.md
    - build/build_receipt.json
    - signal/requirements.md
  required_outputs:
    - gate/merge_decision.md
  optional_outputs: []

runtime_prompt:
  fragments:
    - common/evidence.md
  template: |
    ## Decision Algorithm

    1. Evaluate each Gate check (PASS/WARN/FAIL)
    2. Check requirements readiness (MUST vs SHOULD)
    3. Check fix-forward outcome if applicable
    4. Choose domain verdict (MERGE or BOUNCE)
    5. Map to control-plane routing

    ## Bounce Targeting

    | Failure Mode | Target Flow | Target Agent |
    |--------------|-------------|--------------|
    | Contract Violation | Flow 3 | code-implementer |
    | Missing Spec | Flow 2 | interface-designer |
    | Security Finding | Flow 3 | fixer |
    | Coverage Gap | Flow 3 | test-author |
    | Format/Lint Drift | Flow 3 | fixer |

    ## Output Format

    Write `gate/merge_decision.md` with:
    - Verdict (MERGE | BOUNCE)
    - Evidence Summary (each check outcome)
    - Requirements Readiness
    - Decision Rationale
    - If BOUNCE: target flow and issues to address
    - Next Steps
    - Handoff

handoff:
  path_template: "{{run.base}}/handoff/{{step.id}}.draft.json"
  required_fields:
    - status
    - summary
    - verdict
    - routing_action  # CONTINUE | DETOUR | INJECT_FLOW | INJECT_NODES | EXTEND_GRAPH

invariants:
  - "Never modify code or artifacts - only synthesize and decide"
  - "BOUNCE when any check is FAIL (contracts/security/coverage/receipt)"
  - "MERGE only when all checks are PASS or WARN"
  - "Evidence-tied rationale - no vibes"
  - "Prefer BOUNCE over guessing when key inputs are missing"

routing_hints:
  on_verified: CONTINUE           # MERGE verdict - proceed on golden path
  on_unverified: INJECT_FLOW      # BOUNCE verdict - inject target flow for remediation
  on_partial: DETOUR              # Inject sidequest chain for minor issues
  on_blocked: EXTEND_GRAPH        # Propose patch for unforeseen blockers
