# Station: wisdom-cleanup
# Source: swarm/prompts/agentic_steps/wisdom-cleanup.md
# Role: Seal the envelope at end of Flow 7 (Wisdom) - verify artifacts, write receipt, update index

id: wisdom-cleanup
version: 2
title: Wisdom Cleanup
category: infra

sdk:
  model: haiku
  permission_mode: bypassPermissions
  allowed_tools:
    - Read
    - Write
    - Edit
    - Bash
    - Grep
    - Glob
  sandbox:
    enabled: true
    auto_allow_bash: true
  max_turns: 10
  context_budget:
    total_chars: 100000
    recent_chars: 40000
    older_chars: 6000

identity:
  system_append: |
    You are the Wisdom Cleanup Agent. You seal the envelope at the end of Flow 7.

    You produce the structured summary (receipt) of the wisdom outcome. The receipt
    captures learnings extracted and feedback actions proposed - it is a log, not
    a gatekeeper. It documents what was learned for future runs.

    You own:
    - .runs/<run-id>/wisdom/wisdom_receipt.json
    - .runs/<run-id>/wisdom/cleanup_report.md
    - .runs/_wisdom/latest.md (broadcast file for future runs)
    - Updating .runs/index.json fields you own: status, last_flow, updated_at

    You also aggregate prior flow receipts to create a run summary.
    Use demoswarm shim for all mechanical operations.
  longform_ref: prompts/agentic_steps/wisdom-cleanup.md
  tone: neutral

policy:
  invariants_ref:
    - fragments/common/invariants.md
  handoff_ref:
    - fragments/common/handoff.md

io:
  required_inputs: []
  optional_inputs:
    - wisdom/learnings.md
    - wisdom/feedback_actions.md
    - wisdom/artifact_audit.md
    - wisdom/regression_report.md
    - wisdom/flow_history.json
    - wisdom/risk_assessment.md
    - wisdom/flow_plan.md
    - signal/signal_receipt.json
    - plan/plan_receipt.json
    - build/build_receipt.json
    - gate/gate_receipt.json
    - deploy/deploy_receipt.json
  required_outputs:
    - wisdom/wisdom_receipt.json
    - wisdom/cleanup_report.md
  optional_outputs:
    - wisdom/github_report.md

handoff:
  draft_path_template: "{{run.base}}/handoff/wisdom-cleanup.draft.json"
  schema_ref: schemas/handoff.schema.json
  required_fields:
    - status
    - summary
    - artifacts

verify:
  required_artifacts:
    - wisdom/wisdom_receipt.json
    - wisdom/cleanup_report.md
  gate_status_on_fail: UNVERIFIED

runtime_prompt:
  fragments:
    - common/invariants.md
    - common/handoff.md
  template: |
    ## Wisdom Cleanup Approach

    1. Preflight: verify you can read/write required paths
    2. Artifact existence: check for learnings.md OR feedback_actions.md (at least one)
    3. Mechanical counts: learnings extracted, feedback actions, regressions found
    4. Aggregate prior receipts: read status from each flow's receipt
    5. Write wisdom_receipt.json with counts and flow_summary
    6. Update .runs/index.json (status, last_flow, updated_at only)
    7. Write cleanup_report.md and github_report.md
    8. Write .runs/_wisdom/latest.md (broadcast for future runs)

    ## Status Decision

    - VERIFIED: Required artifacts exist, core counts derived, learnings extracted
    - UNVERIFIED: Missing wisdom artifacts or counts incomplete
    - CANNOT_PROCEED: IO/permissions failure

invariants:
  - "Mechanical counts only - stable markers (^## Learning:, ^- ISSUE:, ^### REG-)"
  - "Null over guess - explain every null in blockers"
  - "Use demoswarm shim for all mechanical operations"
  - "No git operations"
  - "Write .runs/_wisdom/latest.md as scent trail for future runs"

routing_hints:
  on_verified: complete
  on_unverified: advance_with_concerns
  on_partial: advance_with_concerns
  on_blocked: escalate
