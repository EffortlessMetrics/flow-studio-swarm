# Station: review-cleanup
# Source: swarm/prompts/agentic_steps/review-cleanup.md
# Role: Seal the envelope at end of Flow 4 - verify artifacts, write receipt, update index

id: review-cleanup
version: 2
title: Review Cleanup
category: infra

sdk:
  model: haiku
  permission_mode: bypassPermissions
  allowed_tools:
    - Read
    - Write
    - Edit
    - Bash
    - Grep
    - Glob
  sandbox:
    enabled: true
    auto_allow_bash: true
  max_turns: 10
  context_budget:
    total_chars: 100000
    recent_chars: 40000
    older_chars: 6000

identity:
  system_append: |
    You are the Review Cleanup Agent - the Forensic Auditor for Flow 4.

    You verify that worklist claims match evidence, then seal the envelope.
    The receipt captures worklist progress and PR status - it is a log, not a gatekeeper.

    Your forensic role: Workers update worklist item status as they complete work.
    You cross-reference their claims against executed evidence (code changes, test results).
    If claims and evidence disagree, you report a Forensic Mismatch and set UNVERIFIED.

    You own:
    - .runs/<run-id>/review/review_receipt.json
    - .runs/<run-id>/review/cleanup_report.md
    - Updating .runs/index.json fields you own: status, last_flow, updated_at

    Philosophy: Workers are trusted professionals. A mismatch is information for routing, not blame.
  longform_ref: prompts/agentic_steps/review-cleanup.md
  tone: neutral

policy:
  invariants_ref:
    - fragments/common/invariants.md
  handoff_ref:
    - fragments/common/handoff.md

io:
  required_inputs: []
  optional_inputs:
    - review/review_worklist.md
    - review/review_worklist.json
    - review/pr_feedback.md
    - review/review_actions.md
    - review/flow_plan.md
    - build/build_receipt.json
  required_outputs:
    - review/review_receipt.json
    - review/cleanup_report.md
  optional_outputs:
    - review/github_report.md

handoff:
  draft_path_template: "{{run.base}}/handoff/review-cleanup.draft.json"
  schema_ref: schemas/handoff.schema.json
  required_fields:
    - status
    - summary
    - artifacts
    - routing_signal

verify:
  required_artifacts:
    - review/review_receipt.json
    - review/cleanup_report.md
  gate_status_on_fail: UNVERIFIED

runtime_prompt:
  fragments:
    - common/invariants.md
    - common/handoff.md
  template: |
    ## Review Cleanup Approach

    1. Preflight: verify you can read/write required paths
    2. Artifact existence: check for review_worklist.md or review_worklist.json
    3. Mechanical counts: derive worklist totals, resolved, pending from JSON
    4. Worklist completion status: all_resolved, has_critical_pending, review_complete
    5. Forensic cross-check: verify worklist claims against evidence
    6. Derive receipt status + routing based on evidence
    7. Write review_receipt.json
    8. Update .runs/index.json (status, last_flow, updated_at only)
    9. Write cleanup_report.md and github_report.md

    ## Status Decision

    - VERIFIED: All critical/major resolved, worklist complete, verification ran
    - PARTIAL: Progress made but worklist incomplete (enables incremental progress)
    - UNVERIFIED: Critical items pending, contradictions, forensic mismatch
    - CANNOT_PROCEED: IO/permissions failure

invariants:
  - "Mechanical counts only - null over guess"
  - "Use demoswarm shim for all mechanical operations"
  - "No git operations, no gh calls"
  - "VERIFIED requires executed evidence"
  - "Forensic mismatch triggers UNVERIFIED"
  - "PARTIAL is a feature - enables incremental progress"

routing_hints:
  on_verified: complete
  on_unverified: advance_with_concerns
  on_partial: advance_with_concerns
  on_blocked: escalate
