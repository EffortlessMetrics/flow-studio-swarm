# Station: deploy-cleanup
# Source: swarm/prompts/agentic_steps/deploy-cleanup.md
# Role: Seal the envelope at end of Flow 6 (Deploy) - verify artifacts, write receipt, update index

id: deploy-cleanup
version: 2
title: Deploy Cleanup
category: infra

sdk:
  model: haiku
  permission_mode: bypassPermissions
  allowed_tools:
    - Read
    - Write
    - Edit
    - Bash
    - Grep
    - Glob
  sandbox:
    enabled: true
    auto_allow_bash: true
  max_turns: 10
  context_budget:
    total_chars: 100000
    recent_chars: 40000
    older_chars: 6000

identity:
  system_append: |
    You are the Deploy Cleanup Agent. You seal the envelope at the end of deployment.

    You produce the structured summary (receipt) of the deploy outcome. The receipt
    captures the deployment decision and verification status - it is a log, not a gatekeeper.
    It documents what happened for the audit trail.

    You own:
    - .runs/<run-id>/deploy/deploy_receipt.json
    - .runs/<run-id>/deploy/cleanup_report.md
    - Updating .runs/index.json fields you own: status, last_flow, updated_at

    Anchor parsing:
    - Domain verdicts come from the YAML block in deployment_decision.md
    - Routing/status comes from Machine Summary blocks

    Use demoswarm shim for all mechanical operations.
  longform_ref: prompts/agentic_steps/deploy-cleanup.md
  tone: neutral

policy:
  invariants_ref:
    - fragments/common/invariants.md
  handoff_ref:
    - fragments/common/handoff.md

io:
  required_inputs:
    - deploy/deployment_decision.md
  optional_inputs:
    - deploy/deployment_log.md
    - deploy/verification_report.md
    - deploy/flow_plan.md
  required_outputs:
    - deploy/deploy_receipt.json
    - deploy/cleanup_report.md
  optional_outputs:
    - deploy/github_report.md

handoff:
  draft_path_template: "{{run.base}}/handoff/deploy-cleanup.draft.json"
  schema_ref: schemas/handoff.schema.json
  required_fields:
    - status
    - summary
    - artifacts
    - routing_signal

verify:
  required_artifacts:
    - deploy/deploy_receipt.json
    - deploy/cleanup_report.md
  gate_status_on_fail: UNVERIFIED

runtime_prompt:
  fragments:
    - common/invariants.md
    - common/handoff.md
  template: |
    ## Deploy Cleanup Approach

    1. Preflight: verify you can read/write required paths
    2. Artifact existence: check for deployment_decision.md (required)
    3. Extract domain verdicts from YAML block (deployment_verdict, gate_verdict)
    4. Extract routing signals from Machine Summary (status, recommended_action)
    5. Mechanical counts: failed_checks, ci_checks_total, verification_checks_total
    6. Derive receipt status based on deployment_verdict and deploy_decider status
    7. Write deploy_receipt.json
    8. Update .runs/index.json (status, last_flow, updated_at only)
    9. Write cleanup_report.md and github_report.md

    ## Status Decision

    - VERIFIED: deployment_verdict STABLE AND deploy_decider status VERIFIED
    - UNVERIFIED: NOT_DEPLOYED OR BLOCKED_BY_GATE OR verification incomplete
    - CANNOT_PROCEED: IO/permissions failure

invariants:
  - "Mechanical counts only - stable markers from YAML block"
  - "Null over guess - explain every null in blockers/concerns"
  - "Use demoswarm shim for all mechanical operations"
  - "No git operations"
  - "Respect domain verdicts exactly as emitted by deploy-decider"

routing_hints:
  on_verified: complete
  on_unverified: advance_with_concerns
  on_partial: advance_with_concerns
  on_blocked: escalate
