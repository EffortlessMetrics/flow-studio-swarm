{
  "$schema": "../schemas/station.schema.json",
  "id": "secrets-sanitizer",
  "version": 1,
  "title": "Secrets Sanitizer",
  "category": "verification",
  "sdk": {
    "model": "inherit",
    "permission_mode": "bypassPermissions",
    "tool_profile": "read_write",
    "allowed_tools": ["Read", "Write", "Edit", "Bash", "Grep", "Glob", "Skill"],
    "sandbox": {
      "enabled": true,
      "auto_allow_bash": true,
      "excluded_commands": ["git push", "gh issue create", "gh pr create"]
    },
    "max_turns": 12,
    "context_budget": {
      "total_chars": 150000,
      "recent_chars": 50000,
      "older_chars": 15000
    }
  },
  "identity": {
    "system_append": "You are the Secrets Sanitizer: a fix-first pre-commit hook that prevents secrets from being published. Scan the publish surface, fix what you can (redact artifacts, externalize code), and block only when you cannot safely remediate. Never write secret values to any output.",
    "longform_ref": "prompts/agentic_steps/secrets-sanitizer.md",
    "tone": "neutral"
  },
  "policy": {
    "invariants_ref": [
      "fragments/common/invariants.md",
      "fragments/common/run_base.md"
    ],
    "handoff_ref": [
      "fragments/common/handoff.md",
      "fragments/common/status_model.md"
    ]
  },
  "io": {
    "required_inputs": [],
    "optional_inputs": [
      "run_meta.json",
      "<flow>/*"
    ],
    "required_outputs": [
      "<flow>/secrets_scan.md",
      "<flow>/secrets_status.json"
    ],
    "optional_outputs": []
  },
  "handoff": {
    "draft_path_template": "{{run.base}}/{{flow}}/secrets_status.json",
    "schema_ref": "schemas/handoff_envelope.schema.json",
    "required_fields": [
      "status",
      "summary"
    ]
  },
  "verify": {
    "required_artifacts": [
      "<flow>/secrets_status.json"
    ],
    "gate_status_on_fail": "BLOCKED"
  },
  "runtime_prompt": {
    "fragments": [
      "fragments/common/preflight.md",
      "fragments/common/lane_discipline.md",
      "fragments/common/invariants.md",
      "fragments/common/run_base.md"
    ],
    "template": "## Mission\n\nScan and sanitize publish surface for run: {{params.run_id}}, flow: {{params.flow}}.\n\n## Scope (Publish Surface Only)\n\nA) Flow allowlist artifacts:\n- .runs/<run-id>/<flow>/\n- .runs/<run-id>/run_meta.json\n- .runs/index.json\n\nB) Staged changes: git diff --cached --name-only\n\n## Behavior\n\n1. Build scan file list (do not leak secrets)\n2. Detect secrets (pattern-based, conservative)\n3. Remediation: redact artifacts, externalize code when safe\n4. Write secrets_status.json\n5. Return Gate Result block\n6. Write secrets_scan.md\n\n## Status Model\n\n- CLEAN: no findings\n- FIXED: findings remediated\n- BLOCKED: cannot safely remediate"
  },
  "invariants": [
    "Never write secret values to any output (logs, markdown, JSON)",
    "Fix-first for .runs/ - redact in-place using pattern-based replacement",
    "Externalize only when safe/obvious - otherwise set needs_upstream_fix",
    "No encryption-as-sanitization - do not move secrets around",
    "Idempotent - rerunning should converge",
    "Publish scope only - do not scan entire repository"
  ],
  "routing_hints": {
    "on_verified": "advance",
    "on_unverified": "block",
    "on_partial": "block",
    "on_blocked": "escalate"
  }
}
