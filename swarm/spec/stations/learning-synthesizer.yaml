# Station: learning-synthesizer
# Role: Extract actionable lessons from run artifacts

id: learning-synthesizer
version: 1
title: Learning Synthesis
category: analysis

sdk:
  model: sonnet
  permission_mode: bypassPermissions
  allowed_tools:
    - Read
    - Grep
    - Glob
    - Bash
  sandbox:
    enabled: true
    auto_allow_bash: true
  max_turns: 12
  context_budget:
    total_chars: 200000
    recent_chars: 70000
    older_chars: 15000

identity:
  system_append: |
    You are the Learning Synthesizer.

    You operate in Flow 6 (Wisdom). You do not run tools, apply fixes, or create
    GitHub issues. You synthesize evidence from artifacts into durable learnings.

    Primary focus:
    - Improve the flows/agents: What friction did we hit? What agents gave poor
      output? What routing decisions were wrong?
    - Improve the codebase: What architectural issues surfaced? What test gaps
      remain? What patterns should we adopt or avoid?

    Actionable over advisory. If you can't point to evidence, don't write it as a lesson.
    Generic advice is noise.
  tone: thoughtful

io:
  required_inputs:
    - wisdom/artifact_audit.md
    - wisdom/regression_report.md
    - wisdom/flow_history.json
  optional_inputs:
    - signal/open_questions.md
    - plan/adr.md
    - build/test_critique.md
    - build/code_critique.md
    - build/mutation_report.md
    - build/flakiness_report.md
    - build/fuzz_report.md
    - build/doc_critique.md
    - gate/merge_decision.md
    - deploy/deployment_decision.md
    - signal/github_report.md
    - plan/github_report.md
    - build/github_report.md
    - gate/github_report.md
    - deploy/github_report.md
    - signal/signal_receipt.json
    - plan/plan_receipt.json
    - build/build_receipt.json
    - gate/gate_receipt.json
    - deploy/deploy_receipt.json
  required_outputs:
    - wisdom/learnings.md
  optional_outputs: []

runtime_prompt:
  fragments:
    - common/invariants.md
    - common/evidence.md
  template: |
    ## Outcome Snapshot (Priority Order)

    1. Receipts first: Read *_receipt.json files for authoritative status, counts, quality_gates
    2. Machine Summary fallback: If receipt missing, read artifact's ## Machine Summary block
    3. If neither available, record a concern and rely only on clearly labeled sections

    ## Patterns to Extract

    Look for patterns that would have reduced iteration:
    - Requirements ambiguity leading to late rework
    - Missing/weak contracts causing design/build thrash
    - Hardening gaps found late (mutation survivors, fuzz crashes, flaky tests)
    - Gate/deploy surprises (policy ambiguity, security findings, coverage shortfalls)
    - Regressions (what escaped, why, what would have caught it earlier)
    - Pack/flow friction (things harder than they should be, missing automation)

    ## Learning Format

    Each learning must include:
    - Observation (what happened)
    - Impact (rework/iterations/risk)
    - Change (what to do differently - phrased as edit/checklist item)
    - Evidence (file + section pointer)

    ## Stable Markers

    For mechanical counting by wisdom-cleanup:
    - Learning sections: ^## Learning: (Requirements|Design|Build)
    - Actions: ^- ACTION:
    - Pack observations: ^- PACK_OBS:

    ## Advice-to-Action Binding

    Every learning must flow to an action surface:
    - Pack/Flow friction -> PACK_OBS marker -> feedback-applier -> diff or issue draft
    - Codebase insight -> ACTION marker -> follow-up issue or doc update
    - Test gap -> ACTION marker -> test-author worklist item

    Every ## Learning: section must produce at least one ACTION or PACK_OBS marker.

handoff:
  path_template: "{{run.base}}/handoff/{{step.id}}.draft.json"
  required_fields:
    - status
    - summary
    - artifacts
    - blockers
    - concerns

invariants:
  - "Never apply fixes or create GitHub issues"
  - "Every learning must have evidence"
  - "Every Learning section must produce ACTION or PACK_OBS"
  - "Actionable over advisory - no generic advice"
  - "Include DevLT summary from receipts"

routing_hints:
  on_verified: advance
  on_unverified: advance_with_concerns
  on_partial: advance_with_concerns
  on_blocked: escalate
