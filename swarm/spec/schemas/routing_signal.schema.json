{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://flowstudio.dev/schemas/routing_signal.schema.json",
  "title": "RoutingSignal",
  "description": "A routing signal communicates the station's recommendation for next action in the flow.",
  "type": "object",
  "required": ["decision", "confidence", "reason"],
  "properties": {
    "chosen_candidate_id": {
      "type": "string",
      "description": "ID of the routing candidate chosen by Navigator. Must match a candidate_id from the routing_candidates provided to Navigator, or 'extend_graph' for EXTEND_GRAPH decisions."
    },
    "routing_candidates": {
      "type": "array",
      "description": "Pre-computed routing candidates that were available for Navigator to choose from. Populated by the kernel, recorded for audit.",
      "items": {
        "type": "object",
        "required": ["candidate_id", "action"],
        "properties": {
          "candidate_id": {
            "type": "string",
            "description": "Unique identifier for this candidate (deterministic, derived from semantics)"
          },
          "action": {
            "type": "string",
            "enum": ["advance", "loop", "detour", "escalate", "repeat", "terminate"],
            "description": "The routing action this candidate represents"
          },
          "target_node": {
            "type": "string",
            "description": "Target node ID for advance/loop/detour actions"
          },
          "reason": {
            "type": "string",
            "description": "Human-readable explanation of why this is a valid candidate"
          },
          "priority": {
            "type": "integer",
            "minimum": 0,
            "maximum": 100,
            "description": "Priority score (0-100, higher = more likely default)"
          },
          "source": {
            "type": "string",
            "enum": ["graph_edge", "fast_path", "detour_catalog", "extend_graph"],
            "description": "Where this candidate came from"
          },
          "evidence_pointers": {
            "type": "array",
            "items": { "type": "string" },
            "description": "References to evidence supporting this candidate"
          },
          "is_default": {
            "type": "boolean",
            "description": "Whether this is the default/suggested choice"
          }
        },
        "additionalProperties": false
      }
    },
    "routing_source": {
      "type": "string",
      "enum": ["navigator", "fast_path", "deterministic_fallback", "config_default"],
      "description": "How this routing decision was made. Every routing decision is logged, including fast-path decisions."
    },
    "decision": {
      "type": "string",
      "enum": ["advance", "loop", "terminate", "branch", "skip", "fork", "join"],
      "description": "The routing decision made by the station. 'fork' triggers parallel execution of multiple steps; 'join' waits for parallel branches to converge."
    },
    "confidence": {
      "type": "string",
      "enum": ["high", "medium", "low"],
      "description": "Confidence level in the routing decision"
    },
    "next_step": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9_-]*$",
      "description": "Recommended next step ID (for advance/branch decisions)"
    },
    "next_flow": {
      "type": "string",
      "pattern": "^[0-9]+-[a-z]+$",
      "description": "Recommended next flow ID (for cross-flow transitions)"
    },
    "reason": {
      "type": "string",
      "maxLength": 500,
      "description": "Human-readable explanation for the routing decision"
    },
    "loop_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Current iteration count in a microloop"
    },
    "exit_condition_met": {
      "type": "boolean",
      "description": "Whether the exit condition for a microloop has been met"
    },
    "can_further_iteration_help": {
      "type": "boolean",
      "description": "Whether additional iterations could improve the outcome"
    },
    "blockers": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["type", "description"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["missing_input", "validation_failure", "external_dependency", "scope_exceeded", "other"],
            "description": "Type of blocker"
          },
          "description": {
            "type": "string",
            "description": "Description of the blocker"
          },
          "artifact": {
            "type": "string",
            "description": "Related artifact path if applicable"
          },
          "recoverable": {
            "type": "boolean",
            "default": true,
            "description": "Whether this blocker can be resolved by retry or upstream fix"
          }
        },
        "additionalProperties": false
      },
      "description": "List of blockers if decision is terminate or loop"
    },
    "branch_target": {
      "type": "string",
      "description": "Target identifier for branch decisions (condition key or step ID)"
    },
    "fork_targets": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^[a-z][a-z0-9_-]*$"
      },
      "minItems": 2,
      "description": "Step IDs to execute in parallel (for fork decisions). All targets run concurrently."
    },
    "join_strategy": {
      "type": "string",
      "enum": ["all_complete", "all_verified", "any_verified", "first_complete", "quorum"],
      "default": "all_complete",
      "description": "How to aggregate parallel results: 'all_complete' waits for all, 'all_verified' requires all VERIFIED, 'any_verified' proceeds when one succeeds, 'first_complete' uses first result, 'quorum' requires majority."
    },
    "join_quorum": {
      "type": "integer",
      "minimum": 1,
      "description": "Number of branches that must complete for quorum strategy"
    },
    "join_from": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^[a-z][a-z0-9_-]*$"
      },
      "description": "Step IDs that this join is waiting for (populated by orchestrator)"
    },
    "why_now": {
      "type": "object",
      "description": "Structured justification for deviation (DETOUR, INJECT_FLOW, INJECT_NODES). Required when routing goes off the golden path.",
      "properties": {
        "trigger": {
          "type": "string",
          "maxLength": 500,
          "description": "What triggered this deviation (e.g., 'Tests failed with Method Not Found')"
        },
        "analysis": {
          "type": "string",
          "maxLength": 1000,
          "description": "Root cause analysis (e.g., 'Upstream introduced breaking change to Auth interface')"
        },
        "relevance_to_charter": {
          "type": "string",
          "maxLength": 500,
          "description": "How this deviation serves the flow's charter goal (e.g., 'Cannot satisfy AC-2 without upstream fix')"
        },
        "alternatives_considered": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Other options evaluated before choosing this deviation"
        },
        "expected_outcome": {
          "type": "string",
          "maxLength": 500,
          "description": "What this deviation is expected to accomplish"
        }
      },
      "required": ["trigger", "relevance_to_charter"],
      "additionalProperties": false
    },
    "metadata": {
      "type": "object",
      "properties": {
        "station_id": {
          "type": "string",
          "description": "Station that produced this signal"
        },
        "step_id": {
          "type": "string",
          "description": "Step that produced this signal"
        },
        "flow_id": {
          "type": "string",
          "description": "Flow that this signal was produced in"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When the signal was produced"
        },
        "turn_count": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of conversation turns taken"
        }
      },
      "additionalProperties": false
    },
    "confidence_score": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "Numeric confidence (0-1), preferred over string confidence for precision"
    },
    "explanation": {
      "$ref": "routing_explanation.schema.json",
      "description": "Structured routing explanation with LLM reasoning (optional, for audit/debug)"
    },
    "skip_justification": {
      "type": "object",
      "description": "High-friction justification required when decision is 'skip'. Skipping is subtractive and requires explicit audit trail. Detouring (additive) should be cheap; skipping requires justification.",
      "properties": {
        "skip_reason": {
          "type": "string",
          "maxLength": 500,
          "description": "Why this node is being skipped"
        },
        "why_not_needed_for_exit": {
          "type": "string",
          "maxLength": 500,
          "description": "Why this node is not needed to satisfy the flow's exit criteria"
        },
        "replacement_assurance": {
          "type": "string",
          "maxLength": 500,
          "description": "What replaces this node's verification (e.g., a different step, pre-existing artifact, or external validation)"
        }
      },
      "required": ["skip_reason", "why_not_needed_for_exit", "replacement_assurance"],
      "additionalProperties": false
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "decision": { "const": "advance" }
        }
      },
      "then": {
        "anyOf": [
          { "required": ["next_step"] },
          { "required": ["next_flow"] }
        ]
      }
    },
    {
      "if": {
        "properties": {
          "decision": { "const": "branch" }
        }
      },
      "then": {
        "required": ["branch_target"]
      }
    },
    {
      "if": {
        "properties": {
          "decision": { "const": "loop" }
        }
      },
      "then": {
        "required": ["can_further_iteration_help"]
      }
    },
    {
      "if": {
        "properties": {
          "decision": { "const": "skip" }
        }
      },
      "then": {
        "required": ["skip_justification"]
      }
    },
    {
      "if": {
        "properties": {
          "decision": { "const": "fork" }
        }
      },
      "then": {
        "required": ["fork_targets"]
      }
    },
    {
      "if": {
        "properties": {
          "decision": { "const": "join" }
        }
      },
      "then": {
        "required": ["join_strategy"]
      }
    }
  ],
  "additionalProperties": false
}
