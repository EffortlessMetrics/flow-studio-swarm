{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://swarm.dev/schemas/handoff_envelope.schema.json",
  "title": "HandoffEnvelope",
  "description": "Durable per-step handoff artifact for cross-step communication. Contains routing signal, artifact pointers, compressed summary, and structured assumption/decision logs.",
  "type": "object",
  "required": ["step_id", "flow_key", "run_id", "routing_signal", "summary"],
  "properties": {
    "step_id": {
      "type": "string",
      "description": "The step ID that produced this envelope."
    },
    "flow_key": {
      "type": "string",
      "description": "The flow key this step belongs to."
    },
    "run_id": {
      "type": "string",
      "description": "The run ID."
    },
    "routing_signal": {
      "$ref": "https://swarm.dev/schemas/routing_signal.schema.json",
      "description": "The routing decision signal for this step."
    },
    "summary": {
      "type": "string",
      "maxLength": 2000,
      "description": "Compressed summary of step output (1-2k chars max) for context handoff."
    },
    "artifacts": {
      "type": "object",
      "additionalProperties": {
        "type": "string"
      },
      "description": "Map of artifact names to their file paths (relative to RUN_BASE)."
    },
    "file_changes": {
      "type": "object",
      "description": "Forensic file mutation scan results (authoritative, not agent-reported)."
    },
    "status": {
      "type": "string",
      "enum": ["succeeded", "failed", "skipped"],
      "description": "Execution status of the step."
    },
    "error": {
      "type": ["string", "null"],
      "description": "Error message if the step failed."
    },
    "duration_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Execution duration in milliseconds."
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when this envelope was created."
    },
    "station_id": {
      "type": ["string", "null"],
      "description": "Station identifier for spec traceability."
    },
    "station_version": {
      "type": ["integer", "null"],
      "description": "Version of the station spec used."
    },
    "prompt_hash": {
      "type": ["string", "null"],
      "description": "Hash of the prompt template for reproducibility."
    },
    "verification_passed": {
      "type": "boolean",
      "default": true,
      "description": "Whether spec verification passed for this step."
    },
    "verification_details": {
      "type": "object",
      "description": "Detailed verification results and diagnostics."
    },
    "routing_audit": {
      "type": ["object", "null"],
      "description": "Routing audit trail when routing includes explanation."
    },
    "assumptions_made": {
      "type": "array",
      "items": {
        "$ref": "https://swarm.dev/schemas/assumption_record.schema.json"
      },
      "default": [],
      "description": "List of assumptions made during this step's execution. Enables structured JSONL logging of agent assumptions."
    },
    "decisions_made": {
      "type": "array",
      "items": {
        "$ref": "https://swarm.dev/schemas/decision_record.schema.json"
      },
      "default": [],
      "description": "List of decisions logged during this step's execution. Enables structured JSONL logging of agent decisions."
    }
  },
  "additionalProperties": false
}
