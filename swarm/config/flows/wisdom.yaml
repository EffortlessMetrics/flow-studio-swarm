# Flow 7 - Prod → Wisdom (Analysis)
# Source of truth for wisdom flow ordering and agent roles

key: wisdom
title: "Flow 7 - Prod → Wisdom (Analysis)"
description: "Analyze artifacts, detect regressions, extract learnings, close feedback loops."

charter:
  goal: "Extract actionable learnings from the SDLC run and close feedback loops"
  exit_criteria:
    - "Artifact audit confirms all expected outputs from Flows 1-6 exist"
    - "Regression analysis identifies any test/coverage/production regressions"
    - "Flow history compiled with timestamps and routing decisions"
    - "Learnings extracted as actionable patterns"
    - "Feedback actions created (issues, doc updates, template improvements)"
    - "Wisdom summary posted to GitHub"
  non_goals:
    - "Modifying code or tests"
    - "Fixing regressions (create issues instead)"
    - "Making design decisions for future work"
    - "Executing any recommended changes"
  offroad_policy:
    justified:
      - "DETOUR to gather additional context when pattern detection is incomplete"
      - "INJECT_NODES for deeper analysis if routing log shows unusual patterns"
      - "EXTEND_GRAPH proposals for patterns that warrant permanent flow evolution"
    not_justified:
      - "INJECT_FLOW to any earlier flow to fix issues"
      - "Direct modification of flow specs without human review"
      - "Creating implementation tickets without learnings justification"
      - "Skipping feedback loop closure to accelerate completion"

teaching:
  title: "Production to Wisdom: Learning from Every Change"
  summary: "The final flow closes the SDLC loop by analyzing what happened across all flows, detecting regressions, extracting learnings, and creating actionable feedback. Insights from here feed back into Flow 1 (requirements patterns), Flow 2 (design templates), and Flow 3 (test scenarios)."

steps:
  - id: audit
    agents:
      - artifact-auditor
    role: "Verify all expected artifacts from Flows 1-5 exist → artifact_audit.md."
    teaching_note: "First step validates the SDLC produced complete outputs. Missing artifacts indicate flow failures or skipped steps."
    teaching_highlight: true
    routing:
      kind: linear
      next: regression
    teaching_notes:
      inputs:
        - "RUN_BASE/signal/"
        - "RUN_BASE/plan/"
        - "RUN_BASE/build/"
        - "RUN_BASE/gate/"
        - "RUN_BASE/deploy/"
      outputs:
        - "RUN_BASE/wisdom/artifact_audit.md"
      emphasizes:
        - "check all expected artifacts exist"
        - "note missing or incomplete items"
        - "verify artifact timestamps are consistent"
      constraints:
        - "do not modify any artifacts"
        - "report findings, not judgments"

  - id: regression
    agents:
      - regression-analyst
    role: "Analyze tests, coverage, issues, blame for regressions → regression_report.md."
    teaching_note: "Regression analysis looks at test results, coverage changes, and production issues. Did this change introduce problems? Did it fix long-standing issues? This data feeds learning synthesis."
    teaching_highlight: true
    routing:
      kind: linear
      next: history
    teaching_notes:
      inputs:
        - "RUN_BASE/wisdom/artifact_audit.md"
        - "RUN_BASE/build/test_changes_summary.md"
        - "RUN_BASE/gate/coverage_audit.md"
        - "RUN_BASE/deploy/deployment_decision.md"
      outputs:
        - "RUN_BASE/wisdom/regression_report.md"
      emphasizes:
        - "identify test regressions"
        - "analyze coverage changes"
        - "correlate with production issues"
      constraints:
        - "use git blame for attribution"
        - "focus on patterns, not blame"

  - id: history
    agents:
      - flow-historian
    role: "Compile timeline of all flow activity → flow_history.json with timestamps and decisions."
    teaching_note: "The flow historian creates a complete timeline of all decisions across all flows. This enables post-mortem analysis and helps identify bottlenecks in the SDLC."
    teaching_highlight: true
    routing:
      kind: linear
      next: learnings
    teaching_notes:
      inputs:
        - "RUN_BASE/signal/"
        - "RUN_BASE/plan/"
        - "RUN_BASE/build/"
        - "RUN_BASE/gate/"
        - "RUN_BASE/deploy/"
      outputs:
        - "RUN_BASE/wisdom/flow_history.json"
      emphasizes:
        - "compile complete timeline"
        - "capture all routing decisions"
        - "record agent execution times"
      constraints:
        - "use consistent timestamp format"
        - "include all flows, even partial"

  - id: learnings
    agents:
      - learning-synthesizer
    role: "Extract lessons from receipts and critiques → learnings.md with patterns and recommendations."
    teaching_note: "Learning synthesis extracts actionable patterns: What requirements patterns led to smooth implementation? What design decisions caused friction? These become recommendations for future work."
    teaching_highlight: true
    routing:
      kind: linear
      next: feedback
    teaching_notes:
      inputs:
        - "RUN_BASE/wisdom/artifact_audit.md"
        - "RUN_BASE/wisdom/regression_report.md"
        - "RUN_BASE/wisdom/flow_history.json"
        - "RUN_BASE/build/build_receipt.json"
        - "RUN_BASE/gate/merge_decision.md"
      outputs:
        - "RUN_BASE/wisdom/learnings.md"
      emphasizes:
        - "extract actionable patterns"
        - "identify what worked well"
        - "highlight areas for improvement"
      constraints:
        - "focus on systemic patterns"
        - "recommendations must be actionable"

  - id: feedback
    agents:
      - feedback-applier
    role: "Create issues and suggest documentation updates → feedback_actions.md."
    teaching_note: "CLOSED LOOP: The feedback applier creates concrete actions - GitHub issues for missing test scenarios, documentation updates, template improvements. This is how the system improves itself."
    teaching_highlight: true
    routing:
      kind: linear
      next: wisdom_report
    teaching_notes:
      inputs:
        - "RUN_BASE/wisdom/learnings.md"
        - "RUN_BASE/wisdom/regression_report.md"
      outputs:
        - "RUN_BASE/wisdom/feedback_actions.md"
      emphasizes:
        - "create concrete GitHub issues"
        - "suggest documentation updates"
        - "propose template improvements"
      constraints:
        - "use gh CLI for issue creation"
        - "link issues to learnings"

  - id: wisdom_report
    agents:
      - gh-reporter
    role: "Post wisdom summary to PR/issue to close the loop."
    teaching_note: "Final step posts a wisdom summary to GitHub, completing the SDLC feedback loop."
    teaching_highlight: true
    routing:
      kind: linear
    teaching_notes:
      inputs:
        - "RUN_BASE/wisdom/learnings.md"
        - "RUN_BASE/wisdom/feedback_actions.md"
      outputs:
        - "RUN_BASE/wisdom/wisdom_report_posted.md"
      emphasizes:
        - "summarize key learnings"
        - "link to created issues"
        - "close the SDLC loop"
      constraints:
        - "use gh CLI for GitHub operations"
        - "keep summary concise"

cross_cutting:
  - risk-analyst
  - gh-reporter
