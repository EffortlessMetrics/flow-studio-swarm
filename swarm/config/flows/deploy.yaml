# Flow 6 - Artifact → Prod (Deploy)
# Source of truth for deployment flow ordering and agent roles
# This config drives generation of Mermaid diagrams and flow documentation

key: deploy
title: "Flow 6 - Artifact → Prod (Deploy)"
description: "Move an approved artifact from 'ready to merge' to 'deployed'—execute deployment, verify health, create audit trail."

charter:
  goal: "Execute deployment safely and produce a verified deployment decision (STABLE, INVESTIGATE, ROLLBACK, or NOT_DEPLOYED)"
  exit_criteria:
    - "PR merged to target branch (or NOT_DEPLOYED if Gate bounced)"
    - "Git tag and GitHub release created"
    - "CI/deployment events monitored and recorded"
    - "Smoke verification completed"
    - "deployment_decision.md produced with clear status"
  non_goals:
    - "Modifying code (deploy is read-only post-merge)"
    - "Fixing deployment failures (rollback and report only)"
    - "Making architectural decisions"
    - "Debugging production issues beyond smoke tests"
  offroad_policy:
    justified:
      - "DETOUR to extended monitoring when initial smoke tests are inconclusive"
      - "DETOUR to rollback when smoke tests fail critically"
      - "INJECT_NODES for additional health checks if deployment environment differs from expected"
    not_justified:
      - "INJECT_FLOW to build to fix deployment issues"
      - "Modifying code to fix deployment failures"
      - "Skipping smoke verification to accelerate deployment"
      - "Overriding Gate BOUNCE decision"

teaching:
  title: "Artifact to Production: Safe Deployment and Verification"
  summary: "This flow executes the actual merge and verifies the deployed artifact is healthy. It always runs after Gate - even if Gate said BOUNCE, Deploy records WHY deployment did not happen. This creates a complete audit trail."

steps:
  - id: decide
    agents:
      - repo-operator
    role: "Merge PR to target branch, create git tag and GitHub release. Record actions in deployment_log.md."
    teaching_note: "This is the point of no return - the PR gets merged and a release is created. All Gate checks must have passed."
    teaching_highlight: true
    routing:
      kind: linear
      next: monitor
    teaching_notes:
      inputs:
        - "RUN_BASE/gate/merge_decision.md"
        - "RUN_BASE/gate/gate_fix_summary.md"
        - ".git/HEAD"
      outputs:
        - "RUN_BASE/deploy/deployment_log.md"
      emphasizes:
        - "safe git operations only"
        - "create semantic version tag"
        - "record all actions for audit"
      constraints:
        - "no force push"
        - "no destructive commands"
        - "abort if Gate said BOUNCE"

  - id: monitor
    agents:
      - deploy-monitor
    role: "Watch CI/deployment events for the merge commit. Record CI status and deployment events in verification_report.md."
    teaching_note: "Passive monitoring of CI events after merge. This step watches but does not act."
    teaching_highlight: true
    routing:
      kind: linear
      next: smoke
    teaching_notes:
      inputs:
        - "RUN_BASE/deploy/deployment_log.md"
        - ".github/workflows/*.yml"
      outputs:
        - "RUN_BASE/deploy/ci_status.md"
      emphasizes:
        - "track CI pipeline events"
        - "record deployment status"
        - "capture timing information"
      constraints:
        - "passive monitoring only"
        - "do not modify CI config"
        - "wait for reasonable timeout"

  - id: smoke
    agents:
      - smoke-verifier
    role: "Run health checks if endpoints available. Verify artifact/release existence. Append results to verification_report.md."
    teaching_note: "Smoke tests verify the deployed artifact actually works. This is not comprehensive testing - it is quick validation that deployment succeeded and basic functionality works."
    teaching_highlight: true
    routing:
      kind: linear
      next: finalize
    teaching_notes:
      inputs:
        - "RUN_BASE/deploy/deployment_log.md"
        - "RUN_BASE/deploy/ci_status.md"
      outputs:
        - "RUN_BASE/deploy/verification_report.md"
      emphasizes:
        - "verify artifact exists"
        - "check health endpoints if available"
        - "quick validation, not full test"
      constraints:
        - "read-only against production"
        - "short timeout for health checks"
        - "graceful degradation if no endpoints"

  - id: finalize
    agents:
      - deploy-decider
    role: "Synthesize CI + smoke results into deployment_decision.md with status: STABLE/INVESTIGATE/ROLLBACK/NOT_DEPLOYED."
    teaching_note: "The deploy decider produces a final status: STABLE (success), INVESTIGATE (concerning but not broken), ROLLBACK (deployment failed), or NOT_DEPLOYED (Gate bounced). This status feeds into Flow 6 analysis."
    teaching_highlight: true
    routing:
      kind: linear
      next: report
    teaching_notes:
      inputs:
        - "RUN_BASE/deploy/deployment_log.md"
        - "RUN_BASE/deploy/ci_status.md"
        - "RUN_BASE/deploy/verification_report.md"
      outputs:
        - "RUN_BASE/deploy/deployment_decision.md"
      emphasizes:
        - "synthesize all verification data"
        - "produce clear status decision"
        - "explain reasoning for status"
      constraints:
        - "status must be one of: STABLE, INVESTIGATE, ROLLBACK, NOT_DEPLOYED"
        - "document all factors in decision"

  - id: report
    agents:
      - gh-reporter
    role: "Post deployment summary to PR/issue to close the feedback loop."
    teaching_note: "Closing the feedback loop by posting results to the original PR/issue. This ensures stakeholders see the outcome without checking multiple systems."
    teaching_highlight: true
    routing:
      kind: linear
    teaching_notes:
      inputs:
        - "RUN_BASE/deploy/deployment_decision.md"
        - "RUN_BASE/deploy/verification_report.md"
      outputs:
        - "RUN_BASE/deploy/deploy_report_posted.md"
      emphasizes:
        - "close the feedback loop"
        - "post to original PR/issue"
        - "summarize deployment outcome"
      constraints:
        - "use gh CLI for GitHub operations"
        - "include link to deployment artifacts"

cross_cutting:
  - repo-operator
  - gh-reporter
